name: Continuous Deployment

on:
  workflow_run:
    workflows: ["Continuous Integration"]
    types:
      - completed

#Permission to download from another workflow
permissions:
  actions: read
  contents: read

jobs:
    deploy:
        if: ${{ github.event.workflow_run.conclusion == 'success' }}
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Download model artifacts from CI
              uses: dawidd6/action-download-artifact@v2
              with:
                workflow: ci.yml
                workflow_conclusion: success
                run_id: ${{ github.event.workflow_run.id }}
                name: models
                path: ./models
                github_token: ${{ secrets.GITHUB_TOKEN }}
                check_artifacts: true
            
            - name: Download MLFlow artifacts from CI
              uses: dawidd6/action-download-artifact@v2
              with:
                workflow: ci.yml
                workflow_conclusion: success
                run_id: ${{ github.event.workflow_run.id }}
                name: mlruns
                path: ./mlruns
                github_token: ${{ secrets.GITHUB_TOKEN }}
                check_artifacts: true

            - name: Setup Docker
              uses: docker/setup-buildx-action@v2
            
            - name: Log in Docker Hub
              run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
            
            - name: Build images to Docker Hub
              run: docker compose build

            - name: Push images to Docker Hub
              run: |
                docker push achrafaitelquadi/mlops-alzheimer-detection-app:fastapi-latest
                docker push achrafaitelquadi/mlops-alzheimer-detection-app:mlflow-latest
                docker push achrafaitelquadi/mlops-alzheimer-detection-app:nginx-latest

            - name: Deploy with Docker compose
              run: docker compose up -d